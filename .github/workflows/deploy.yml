name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: seno-blackdragon
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "ğŸ”’ Adding github.com to known_hosts..."
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts

            APP_NAME=${{ github.event.repository.name }}
            APP_DIR=~/../home/apps/$APP_NAME
            echo "ğŸ“ Preparing app directory: $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repo..."
              git clone git@github.com:${{ github.repository }} . --branch main
            else
              echo "ğŸ“¦ Pulling latest code..."
              git fetch origin main
              git reset --hard origin/main
            fi

            echo "ğŸ§¹ Stopping and cleaning up existing containers..."
            docker compose down --remove-orphans || true

            echo "ğŸ“¦ Docker Compose build & deploy..."
            docker compose pull || true
            docker compose build --no-cache
            docker compose up -d --remove-orphans

            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
